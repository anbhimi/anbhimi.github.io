<!DOCTYPE html>
<html>
<head>
<title>Visualization Project</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Raleway">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<script src="https://d3js.org/d3.v3.min.js"></script>
<script src="https://d3js.org/queue.v1.min.js"></script>
<script type="text/javascript" src="https://d3js.org/topojson.v1.min.js"></script>

</head>
<style>


path {
  stroke:white;
  stroke-width: 1px;
  fill:black;
}

div.tooltip {
  position: absolute;
  display: block;
  z-index: 3;
  left: 75px;
  text-align: center;
  height: 30px;
  padding: 5px;
  font-size: 16px;
  background:lightblue;
  border: 1px solid #989898;
  pointer-events: none;
}

div.tooltip1 {
  position: absolute;
  display: block;
  z-index: 3;
  left: 75px;
  text-align: center;
  height: 47px;
  padding: 5px;
  font-size: 16px;
  background:lightblue;
  border: 1px solid #989898;
  pointer-events: none;
}


body {
  font: 10px arial;
}

.axis path,
.axis line {
  fill: none;
  stroke: black;
  shape-rendering: crispEdges;
}

.yaxis path,
.yaxis line {
  fill: none;
  stroke: black;
  shape-rendering: crispEdges;
}

axis path {
  display: none;
}
    	/* text {
			font-family: Arial;
			font-size: 15px;
		}
		.axis path, .axis line {
			fill: none;
			stroke: black;
			shape-rendering: crispEdges;
		}
		.tick text {
			fill: gray;
			font-size: 11px;
		}

		rect {
			stroke: white;
		}

} */


/* .svg {
  position: absolute;
  animation: panZoom 10s linear 1;
} */


/*
.legend rect {
  fill: white;
  fill-opacity: .85;
  stroke: white;
}
.legend text {
  font-size: 12px;
}
path {
    stroke-width: 1;
    fill: none;
    stroke-linejoin: round;
    stroke-linecap: round;
}
circle {
  stroke-width: 1;
}
.axis path,
.axis line {
  fill: none;
  stroke: grey;
  stroke-width: 1;
  shape-rendering: crispEdges;
}
.legend, .label, .hover-text{
    font-size: x-small;
    background-color: white;
} */

.grid-container {
  display: grid;
  grid-template-areas: 'myArea1 myArea2';
  grid-template-columns: 40vw 60vw;
  grid-template-rows: auto;
  grid-gap: 5px;
  padding: 5px;
  text-align: center;
}

.item1 {
  grid-area: myArea1;
}

.item2 {
  grid-area: myArea2;
}

.item11 { grid-area: pie; }
.item1label1 { grid-area: legend1; }
.item21 { grid-area: pie2; }
.item2label1 { grid-area: legend2; }

.grid-container1 {
  display: grid;
  grid-template-areas:'pie legend1 pie2 legend2';
  grid-template-columns: 255px 110px 255px 110px;
  grid-template-rows: auto;
  grid-gap: 5px;
  padding: 5px;
  text-align: center;
}

#pie11 {
    margin: auto;
    background-color: white;
  }

#pie21 {
    width: 80%;
    margin: auto;
    background-color: white;
}

.label-text {
    alignment-baseline: middle;
    font-size: 12px;
    font-family: arial,helvetica,"sans-serif";
    fill: #393939;
}
.label-line {
    stroke-width: 1;
    /* stroke: #393939; */
}
.label-circle {
    fill: #393939;
}

.rounder {
    height: 10px;
    width: 10px;
    border-radius: 50%;
    display: inline-block;
}

.boundBox {
    border: 1px black solid;
    padding: 10px;
    width: 43%;
    text-align: left;
    margin-top: 90px;
}

#pie1label1 {
  text-align: left;
  border: 1px black solid;
  padding:5px;
}

#pie2label1 {
  border: 1px black solid;
  text-align: left;
  padding:5px;
}

</style>


<body>



<!-- Navbar (sit on top) -->
<div class="w3-top">
  <div class="w3-bar w3-white w3-card" id="myNavbar">
    <a href="Project2.html" class="w3-bar-item w3-button w3-wide"><b>Visualization of jail deaths in the USA</b></a>
    <!-- Right-sided navbar links -->
    <div class="w3-right w3-hide-small">
      <a href="project2_index.html" class="w3-bar-item w3-button"><b>About</b></a>
	  <a href="project2_V3.html" class="w3-bar-item w3-button"><b>Visualization</b></a>
      <a href="project2_documentation.html" class="w3-bar-item w3-button"></i><b>Document</b></a>
	  <a href="project2_video.html" class="w3-bar-item w3-button"><b></i>Presentation</b></a>
    </div>
	    <a href="javascript:void(0)" class="w3-bar-item w3-button w3-right w3-hide-large w3-hide-medium" onclick="w3_open()">
      <i class="fa fa-bars"></i>
    </a>
  </div>
    <a href="javascript:void(0)" class="w3-bar-item w3-button w3-right w3-hide-large w3-hide-medium" onclick="w3_open()">
      <i class="fa fa-bars"></i>
    </a>
</div>




<div id="JailDeaths_By_Cat" class="chart">
   <div class="title"></div>
</div>

<div class="grid-container">
  <div style="position: absolute; margin-top:100px;z-index: 1000;">
    <button id="zoom-in">+</button>
    <button id="zoom-out">-</button>
  </div>
  <div class="item1">

  </div>
  <div class="item2">
    <div class="item2line">

    </div>
    <div class="grid-container1">
      <div class="item11">
          <div id="pie11"></div>
      </div>
      <div class="item1label1">
          <div id="pie1label1"></div>
      </div>
      <div class="item21">
          <div id="pie21"></div>
      </div>
      <div class="item2label1">
          <div id="pie2label1"></div>
      </div>
  </div>
  <div class="item2bar">

  </div>
  </div>
</div>

<script>

var width_map = 760, height_map = 600;
var color_domain = [5,10, 15, 20, 25, 30];
var ext_color_domain = [0, 5, 10, 15, 20, 25, 30];
var legend_labels = ["0-5", "5-10", "10-15", "15-20", "20-25", "25-30","30+"];

var color_map = d3.scale.threshold()
                    .domain(color_domain)
                    .range(['#ffffd4','#fee391','#fec44f','#fe9929','#ec7014','#cc4c02','#8c2d04']);

var tooltip_map = d3.select("body").append("div")
            .attr("class", "tooltip")
             .style("opacity", 0);

 var svg_map = d3.select(".item1").append("svg")
               .attr("width", width_map)
               .attr("height", height_map)
               .attr("transform","translate(-160,10)");

 var svg_map2 = d3.select("body").append("svg")
              .attr("width", 600)
              .attr("height", 200)
              .attr("transform","translate(20,-200)");

svg_map.append("text")
        .attr("class","maptitle")
        .attr("x", (width_map / 1.5))
        .attr("y", (height_map / 12))
        .attr("text-anchor", "middle")
        .style("font-size", "16px")
        .text("County-wise jail deaths in USA");


 var legend_map = svg_map2.selectAll("g.legend")
                       .data(ext_color_domain)
                       .enter().append("g")
                       .attr("class","legend_map");

 legend_map.append("rect")
           .attr("x", function(d,i){return (50 + (i*70));})
           .attr("y", 50)
           .attr("width", 70)
           .attr("height", 20)
           .attr("fill", function(d,i){return color_map(d);});

 legend_map.append("text")
           .data(legend_labels)
           .attr("x", function(d,i){return (50 + (i*70));})
           .attr("y", 90)
           .attr("class","legend_map_label")
           .text(function(d,i){return legend_labels[i];});

 legend_map.append("text")
           .attr("x", 50)
           .attr("y", 30)
           .attr("class","legend_map_title")
           .text("Number of Deaths")
           .style("font-family", "sans-serif");

 var deaths_data = [];

 var bind_id_deaths = {};
 var bind_id_name = {};
 var bind_id_percent = {};
 var bind_id_adp = {};

 //function for initial preprocessing of data
 function deaths_total(data){

   //Data Preprocessing for Map
   data.forEach(function(d){
         var total_deaths = parseInt(d.d2008)+ parseInt(d.d2009) + parseInt(d.d2010) + parseInt(d.d2011)
                         + parseInt(d.d2012) + parseInt(d.d2013)+parseInt(d.d2014)+ parseInt(d.d2015)
                         + parseInt(d.d2016) + parseInt(d.d2017) + parseInt(d.d2018) + parseInt(d.d2019);
         //console.log(total_deaths);

         var avg_year = parseInt(d.d2008)/parseInt(d.adp2008)+ parseInt(d.d2009)/parseInt(d.adp2009)
                   + parseInt(d.d2010)/parseInt(d.adp2010) + parseInt(d.d2011)/parseInt(d.adp2011);
                         // + parseInt(d.d2012)/parseInt(d.adp2012) + parseInt(d.d2013)/parseInt(d.adp2013)
                         // + parseInt(d.d2014)/parseInt(d.adp2014)+ parseInt(d.d2015)/parseInt(d.adp2015)
                         // + parseInt(d.d2016)/parseInt(d.adp2016) + parseInt(d.d2017)/parseInt(d.adp2017)
                         //  + parseInt(d.d2018)/parseInt(d.adp2018) + parseInt(d.d2019)/parseInt(d.adp2019);

         var total_adp = parseFloat(d.adp2008)+ parseFloat(d.adp2009) + parseFloat(d.adp2010) + parseFloat(d.adp2011)
                         + parseFloat(d.adp2012) + parseFloat(d.adp2013)+parseFloat(d.adp2014)+ parseFloat(d.adp2015)
                         + parseFloat(d.adp2016) + parseFloat(d.adp2017) + parseFloat(d.adp2018);

         var avg_adp = (total_adp/11);
         var percentage_deaths = (total_deaths/avg_adp)*100;
         //console.log(percentage_deaths);

         bind_id_percent[parseInt(d.fips)] = total_deaths;
         bind_id_name[parseInt(d.fips)] = d.county;
         //bind_id_deaths[parseInt(d.fips)] = total_deaths;
         bind_id_adp[parseInt(d.fips)] = Math.round(avg_adp);
       });

 };

 function deaths_by_year(data, year){

    data.forEach(function(d){

      //year = '2008';
      colname = 'd'+year;
      colname2 = 'adp'+year;

      percentage_deaths = ((d[colname])/(d[colname2]))*100;
      bind_id_percent[parseInt(d.fips)] = d[colname];
      bind_id_name[parseInt(d.fips)] = d.county;
      bind_id_deaths[parseInt(d.fips)] = d[colname];
      bind_id_adp[parseInt(d.fips)] = Math.round(d[colname2]);

      //console.log(d[colname]);



    });

      draw_map();

 };

 //reading csv file
 d3.csv("modified_jails_data.csv")
       .get(function(error, data_csv){
           deaths_data = data_csv;

           deaths_total(deaths_data);

          // deaths_by_year(deaths_data,'2010');

          });

          //console.log(deaths_data.length);

          var county_data = [];

          d3.json("us.json")
            .get(function(error, data_us){

              county_data = data_us;
        //  var g_map = svg_map.append("g");

             svg_map.append("g")
             .attr("class", "county")
             .selectAll("path")
             .data(topojson.feature(data_us, data_us.objects.counties).features)
             .enter().append("path")
             .attr("d", d3.geo.path().projection(d3.geo.albersUsa().scale(800)))
             .style("opacity", 0.8)
             .style("fill", function(d){
               return color_map (bind_id_percent[d.id]);
             })
              .on("mouseover", function(d) {
                     //var sel = d3.select(this);
                d3.select(this)
                    .transition()
                    .duration(300)
                    .style({'opacity': 1,
                            'stroke': 'black',
                            'stroke-width': 1.5});

                    tooltip_map.transition().duration(300)
                            .style("opacity", 1);

                    tooltip_map.html(d)
                    .style("left", (d3.event.pageX) + "px")
                    .style("top", (d3.event.pageY) + (-30)+"px")
                    .style("opacity","1")
                    .text(bind_id_name[d.id] + " : " + bind_id_percent[d.id]
                            +", ADP: " +bind_id_adp[d.id]);
                    //.text(bind_id_name[d.id] + " : " + Math.round((bind_id_percent[d.id] + Number.EPSILON) * 100) / 100)
              })
              .on("mouseout", function() {
                   var sel = d3.select(this);
                  d3.select(this)
                  .transition().duration(300)
                  .style({'opacity': 0.8, 'stroke': 'white', 'stroke-width': 1});
                  tooltip_map.transition().duration(300)
                  .style("opacity", 0);
              });

              // fill_color();


           var zoom = d3.behavior.zoom()
              .translate([0, 0])
              .scale(1)
              .scaleExtent([1, 8])
              .on("zoom", zoomed);

          svg_map.call(zoom);

          function zoomed() {
              svg_map.attr("transform",
                  "translate(" + zoom.translate() + ")" +
                  "scale(" + zoom.scale() + ")"
              );
          }

          function interpolateZoom (translate, scale) {
              var self = this;
              return d3.transition().duration(270).tween("zoom", function () {
                  var transIt = d3.interpolate(zoom.translate(), translate),
                      scaleIt = d3.interpolate(zoom.scale(), scale);
                  return function (t) {
                      zoom
                          .scale(scaleIt(t))
                          .translate(transIt(t));
                      zoomed();
                  };
              });
          }

          function zoomClick() {
              var direction = 1,
                  translate = zoom.translate(),
                  translate0 = [],        factor = 0.2,
                  l = [],
                  extent = zoom.scaleExtent(),
                  target_zoom = 1,
                  center = [width / 2, height / 2],
                  view = {x: translate[0], y: translate[1], k: zoom.scale()};

              d3.event.preventDefault();
              direction = (this.id === 'zoom-in') ? 1 : -1;
              target_zoom = zoom.scale() * (1 + factor * direction);

              if (target_zoom < extent[0] || target_zoom > extent[1]) { return false; }

              translate0 = [(center[0] - view.x) / view.k, (center[1] - view.y) / view.k];
              view.k = target_zoom;
              l = [translate0[0] * view.k + view.x, translate0[1] * view.k + view.y];

              view.x += center[0] - l[0];
              view.y += center[1] - l[1];

              interpolateZoom([view.x, view.y], view.k);
          }

          d3.selectAll('button').on('click', zoomClick);
           // function fill_color(){
           //    svg_map.data(county_data)
           //        );
           // };
          });

          function draw_map(){


            d3.json("us.json")
              .get(function(error, data_us){

                //svg_map.selectAll(".county").style("opacity",0).remove();
                //  console.log(county_data);

                var color_domain = [1,2, 3, 4, 5,6];

                var color_map = d3.scale.threshold()
                                    .domain(color_domain)
                                    .range(['#ffffd4','#fee391','#fec44f','#fe9929','#ec7014','#cc4c02','#8c2d04']);

                var ext_color_domain = [0, 1, 2, 3, 4, 5, 6];
                var legend_labels = ["0", "1", "2", "3", "4", "5","6+"];

                legend_map.selectAll(".legend_map_label").remove();

                legend_map.append("text")
                          .data(legend_labels)
                          .attr("x", function(d,i){return (50 + (i*70));})
                          .attr("y", 90)
                          .attr("class","legend_map_label")
                          .text(function(d,i){return legend_labels[i];});


                svg_map.selectAll("g > *").style("opacity",0).remove();

                svg_map.selectAll("path.county").style("opacity",0).remove();


                 svg_map.append("g").selectAll(".county")
                     .attr("class","county")
                    .data(topojson.feature(county_data, county_data.objects.counties).features)
                   .enter().append("path")
                    .attr("d", d3.geo.path().projection(d3.geo.albersUsa().scale(800)))
                    .style("opacity", 0.8)
                    .style("fill", function(d){
                      return color_map (bind_id_percent[d.id]);
                    })
                     .on("mouseover", function(d) {
                            //var sel = d3.select(this);
                       d3.select(this)
                           .transition()
                           .duration(300)
                           .style({'opacity': 1,
                                   'stroke': 'black',
                                   'stroke-width': 1.5});

                           tooltip_map.transition().duration(300)
                                   .style("opacity", 1);

                           tooltip_map.html(d)
                           .style("left", (d3.event.pageX) + "px")
                           .style("top", (d3.event.pageY) + (-30)+"px")
                           .style("opacity","1")
                           .text(bind_id_name[d.id] + " : " + bind_id_percent[d.id]  + ", ADP: " +bind_id_adp[d.id])
                           //.text(bind_id_name[d.id] + " : " + Math.round((bind_id_percent[d.id] + Number.EPSILON) * 100) / 100)
                     })
                     .on("mouseout", function() {
                          var sel = d3.select(this);
                         d3.select(this)
                         .transition().duration(300)
                         .style({'opacity': 0.8, 'stroke': 'white', 'stroke-width': 1});
                         tooltip_map.transition().duration(300)
                         .style("opacity", 0);
                     });


                //     fill_color();

              });


   };

  // draw_map();



     // Draw a line chart
     var width = 450;
     var height = 200;

     var svg = d3.select(".item2line").append("svg")
                                         .attr("width", "600")
                                         .attr("height", "300");
                                        //  .attr("transform","translate(-70, -250)");

svg.append("text")
        .attr("x", (width / 1.5))
        .attr("y", (50))
        .attr("text-anchor", "middle")
        .style("font-size", "12px")
        .text("Timeline graph of jail deaths based on causes of deaths per year");

    var g = svg.append("g")
                .attr("transform", "translate(50,70)");

    var margin = { top: 50, right: 0, bottom: 20, left: 0 };
     // var svg = d3.select("svg"),//"#JailDeaths_By_Cat").append("svg"),
     //   margin = { top: 100, right: 80, bottom: 20, left: 950 },
     //   width = +svg.attr('width') - margin.left - margin.right,
     //   height = +svg.attr('height') - margin.top - margin.bottom,
     //   g = svg.append('g').attr('transform', 'translate(' + margin.left + ',' + margin.top + ')');
     // // Graph title
     // g.append('text')
     //   .attr('x', (width / 2))
     //   .attr('y', 0 - (margin.top / 3))
     //   .attr('text-anchor', 'middle')
     //   .style('font-size', '16px')
     //   .text('Jail Deaths by Category from 2008 to 2019');
     // Function to convert a string into a time

     // Set the X scale
     var x = d3.scale.linear().range([0, 450]);
     // Set the Y scale
     var y = d3.scale.linear().range([200, 0]);
     var yTicks = d3.scale.linear().range([200, 0]);   // kavitha
     // Set the color scale
     var color = d3.scale.category10();

     var xAxis = d3.svg.axis()
     .scale(x)
     .orient("bottom")
     .tickFormat(d3.format("d"));

     var yAxis = d3.svg.axis()
     .scale(y)
     .orient("left");
	
     var yTicksAxis = d3.svg.axis()    /// kavitha
     .scale(yTicks)
     .orient("left")
     .ticks(10);

     var logval = d3.scale.log().range([0,2]); 

     function buildmultiLine(){

     var line = d3.svg.line()
     // .interpolate("basis")
     .x(function(d) {
       return x(d.Year);
     })
     .y(function(d) {
       return y(logval(+d.Tot_Deaths));  /// kavitha
     });

       // load the data
     d3.csv("all_jails_aggregated.csv", function(error, data) {
      //console.log(data);
       // Select the important columns

      var chartstats = d3.nest() // nest function allows to group the calculation per level of a factor
         .key(function(d) { return d.Category;})
         .entries(data);

       color.domain(chartstats.map(function(d){ console.log(d.key); return '"'+d.key+'"'; }))


       // Set the X domain

       x.domain(d3.extent(data, function(d) {
         return d.Year;}));
       // Set the Y domain
       y.domain([
         d3.min(chartstats, function(c) {
           return d3.min(c.values, function(v) {
             //// return +v.Tot_Deaths;  // Kavitha
             return logval(+v.Tot_Deaths);
           });
         }),
         d3.max(chartstats, function(c) {
           return d3.max(c.values, function(v) {
             /// return +v.Tot_Deaths;    // kavitha
             return logval(+v.Tot_Deaths);
           });
         })
       ]);
	     
     //// for ticks, kavitha
       yTicks.domain([
         d3.min(chartstats, function(c) {
                  return d3.min(c.values, function(v) {
	                //console.log(logval(+v.Tot_Deaths));
                        return +v.Tot_Deaths; //  this original code -- kavitha
		//return logval(+v.Tot_Deaths);
               });
               }),
       d3.max(chartstats, function(c) {
             return d3.max(c.values, function(v) {
	            //console.log(logval(+v.Tot_Deaths));
              return +v.Tot_Deaths; //  this original code -- kavitha
	         //return logval(+v.Tot_Deaths);
              });
              })
           ]);
	     
	     
       // Set the X axis
       g.append("g")
         .attr("class", "x axis")
         .attr("transform", "translate(0," + height + ")")
         .call(xAxis);
       // Set the Y axis
       g.append("g")
         .attr("class", "y axis")
         .call(yTicksAxis)   /// added by kavitha
         .append("text")
         .attr("transform", "rotate(0)")
         .attr("y", 2)
         .attr("dy", ".90em")
         .style("text-anchor", "top")
         .text("Number of deaths");

       // Draw the lines
       var linchart = g.selectAll(".linchart")
         .data(chartstats)
         .enter().append("g")
         .attr("class", "linchart");

       linchart.append("path")
         .attr("class", "line")
         .style("fill","none")
         .attr("d", function(d) {
           return line(d.values);
         })
         .style("stroke", function(d) {
           return color(d.key);
         });
       // Add the circles
       linchart.append("g").selectAll("circle")
         .data(function(d){return d.values})
         .enter()
         .append("circle")
         .attr("r", 1)
         .attr("cx", function(dd){return x(dd.Year)})
         .attr("cy", function(dd){return y(logval(+dd.Tot_Deaths))})   // updated by kavitha
         .attr("fill", "none")
         .attr("stroke", function(d){return color(d.Category)});
       // Add label to the end of the line
       linchart.append("text")
         .attr("class", "label")
         .datum(function (d) { //console.log(d); console.log(d.key);
           return {
             Category: d.key,
             value: d.values[d.values.length - 1]
           };
         })
         .attr("transform", function (d) {//console.log(d);
           return "translate(" + x(d.value.Year) + "," + y(logval(+d.value.Tot_Deaths)) + ")";   /// updated by kavitha
         })
         .attr("x", 3)
         .attr("dy", ".35em")
	 .style('fill',function(d){return color(d.Category);}) // updated color of text -- kavitha
         .text(function (d) {
           return d.Category;
       });

     // Add the mouse line
     var mouseG = g.append("g")
       .attr("class", "mouse-over-effects");

     mouseG.append("path")
       .attr("class", "mouse-line")
       .style("stroke", "black")
       .style("stroke-width", "1px")
       .style("opacity", "0");

     var lines = document.getElementsByClassName('line');

     console.log(chartstats);

     var mousePerLine = mouseG.selectAll('.mouse-per-line')
       .data(chartstats)
       .enter()
       .append("g")
       .attr("class", "mouse-per-line");

     mousePerLine.append("circle")
       .attr("r", 2)
       .style("stroke", function (d) { //console.log(d);
         return color(d.Category);
       })
       .style("fill", "silver")
       .style("stroke-width", "1px")
       .style("opacity", "0");

     mousePerLine.append("text")
         .attr("class", "hover-text")
         .attr("dy", "-1em")
         .attr("transform", "translate(10,3)");

     // Append a rect to catch mouse movements on canvas
     mouseG.append('svg:rect')
       .attr('width', width)
       .attr('height', height)
       .attr('fill', 'none')
       .attr('pointer-events', 'all')
       .on('mouseout', function () { // on mouse out hide line, circles and text
         d3.select(".mouse-line")
           .style("opacity", "0");
         d3.selectAll(".mouse-per-line circle")
           .style("opacity", "0");
         d3.selectAll(".mouse-per-line text")
           .style("opacity", "0");
       })
       .on('mouseover', function () { // on mouse in show line, circles and text
         d3.select(".mouse-line")
           .style("opacity", "1");
         d3.selectAll(".mouse-per-line circle")
           .style("opacity", "1");
         d3.selectAll(".mouse-per-line text")
           .style("opacity", "1");
       })
       .on('click', function () { // click over canvas
         var mouse = d3.mouse(this);
         var year;
         d3.selectAll(".mouse-per-line")
           .attr("transform", function (d, i) { //console.log(d);

             var xDate = x.invert(mouse[0]),
               bisect = d3.bisector( function (d) { return d.Year; }).left;
             idx = bisect(d.values, xDate);
             year = d.values[idx].Year;

            // Update pie
            pieBuilterData({year: year});


             d3.select(this).select('text')
               .text(y.invert(y(d.values[idx].Tot_Deaths)).toFixed(2));

             d3.select(".mouse-line")
               .attr("d", function () {
                 var data = "M" + x(d.values[idx].Year) + "," + height;
                 data += " " + x(d.values[idx].Year) + "," + 0;
                 return data;
               });
             return "translate(" + x(d.values[idx].Year) + "," + y(logval(d.values[idx].Tot_Deaths)) + ")";  //// updated by kavitha
           });

           svg_map.selectAll(".maptitle").remove();
           svg_map.append("text")
                   .attr("class","maptitle")
                   .attr("x", (width_map / 1.5))
                   .attr("y", (height_map / 12))
                   .attr("text-anchor", "middle")
                   .style("font-size", "16px")
                   .text("County-wise jail deaths in USA - " +year);


              deaths_by_year(deaths_data, year);
              group_year( year);

       });


     });
     }

     buildmultiLine();

     //Grouped bar chart

          var margin_group = {top: 30, right: 30, bottom: 30, left: 50};
              var width_group = 450 - margin_group.left - margin_group.right;
            var  height_group = 200 - margin_group.top - margin_group.bottom;

              var tooltip_group = d3.select(".item2bar").append("div")
                          .attr("class", "tooltip")
                           .style("opacity", 0);


              var x0_group = d3.scale.ordinal()
                  .rangeRoundBands([0, width_group], .1);

              var x1_group = d3.scale.ordinal();

              var y_group = d3.scale.linear()
                  .range([height_group, 0]);

              var xAxis_group = d3.svg.axis()
                  .scale(x0_group)
                  .tickSize(0)
                  .tickFormat(function(d){
                     var mapper = {"NA":"N/A", "C":"Convicted","U":"Unconvicted"};
                     return mapper[d];
                  })
                  .orient("bottom");
              //
              var yAxis_group = d3.svg.axis()
                  .scale(y_group)
                  .orient("left");
                //  .attr("class","y axis");

              var color_group = d3.scale.ordinal()
                  .range(['#91bfdb','#fc8d59','#ffffbf']);

              var svg_group = d3.select('.item2bar').append("svg")
                  .attr("width", width_group+margin_group.left+margin_group.right )
                  .attr("height", height_group + margin_group.top + margin_group.bottom)
                  .append("g")
                  .attr("transform", "translate(" + margin_group.left + "," + margin_group.top + ")");

                  const result = {};
                  var grouped_data = [];
                  var max_map = [];

                function group_year(year){
                    //data preprocessing - yearwise
                    //console.log(result);
                  format_data(result, year);
                  update_bar();

                 };

                 function format_data(data, year){
                   var arr = new Map(Object.entries(data[year]));
                   console.log(arr);
                   res_group = [];
                 //  data = JSON.parse(data);
                   arr.forEach(function(val, key) {
                       var values = []
                       // var male_count = val['M'];
                       // var female_count = val['F'];
                       // var na_count = val['NA'];
                       values.push({gender:'M', count: val['M']});
                       values.push({gender:'F', count: val['F']});
                       values.push({gender:'NA', count:val['NA']});

                       res_group.push({custody_status: key, value:values});
                      // console.log("Format data is also executed "+res_group);
                      console.log(res_group);

                 });

                 max_map = [];
                   max_map = res_group.map(function(o){
                                 a = o.value;

                                 max = Math.max.apply(Math, a.map(function(o) { val = o.count
                                             if (val == undefined){
                                               val = 0;
                                             };
                                           return val;}))
                                 return max;
                         });
                 console.log("Max value :" +max_map);
                 update_bar(res_group);
                 return res_group, max_map;
               };

                var slice;


               //reading csv file
               d3.csv("modified_deaths_data.csv")
                   .get(function(error, data_csv){
                       grouped_data = data_csv;

                     var custody_status_values = grouped_data.map(function(d){return d.custody_status;});
                     var custody_status = Array.from(new Set(custody_status_values));
                     //console.log(custody_status_names);

                     var gender = ["M", "F", "NA"];

                     //const result = {};
                     const custodyStatusMap = new Set();
                     var res_group = [];
                   // //  data preprocessing - yearwise
                         grouped_data.forEach((item) => {
                           const item_year_num = Number(item.year);
                           custodyStatusMap.add(item.custody_status);
                           if (result[item_year_num]) {
                             if (result[item_year_num][item.custody_status]) {
                               if (result[item_year_num][item.custody_status][item.gender]) {
                                 result[item_year_num][item.custody_status][item.gender] += 1;
                               } else {
                                 result[item_year_num][item.custody_status][item.gender] = 1;
                               }
                             } else {
                               result[item_year_num][item.custody_status] = { [item.gender]: 1 };
                             }
                           } else {
                             result[item_year_num] = {
                               [item.custody_status]: { [item.gender]: 1 },
                             };
                           }
                         });
                   //
                   //
                 //   format_data(result, '2008');
                       // var arr = new Map(Object.entries(result[2008]));
                       // console.log(arr);
                       // var test = [];
                       // arr.forEach(function(val, key){
                       //     var values = []
                       //     // var male_count = val['M'];
                       //     // var female_count = val['F'];
                       //     // var na_count = val['NA'];
                       //     values.push({gender:'M', count: val['M']});
                       //     values.push({gender:'F', count: val['F']});
                       //     values.push({gender:'NA', count:val['NA']});
                       //
                       //     test.push({custody_status: key, value:values});
                       //   });


                       // console.log(test);
                       // max_map = test.map(function(o){
                       //                 a = o.value;
                       //
                       //                 max = Math.max.apply(Math, a.map(function(o) { val = o.count
                       //                             if (val == undefined){
                       //                               val = 0;
                       //                             };
                       //                           return val;}))
                       //                 return max;
                       //         });




                     //Consolidated data - totals based on gender and custody_status

                     var data_group = {};

                     grouped_data.forEach((item) => {
                       const item_custody_status = item.custody_status;

                       if (data_group[item_custody_status]) {
                         if (data_group[item_custody_status][item.gender]) {
                               data_group[item_custody_status][item.gender] += 1;
                           } else {
                             data_group[item_custody_status][item.gender] = 1;
                           }
                         } else {
                           data_group[item_custody_status]= { [item.gender]: 1 };
                         };
                       });

                       //console.log(data_group);

                       const data_map_group = new Map(Object.entries(data_group));
                       //console.log(data_map_group);

                     //  res_group = format_data(data_map_group);

                     data_map_group.forEach(function(val, key) {
                         var values = []
                         // var male_count = val['M'];
                         // var female_count = val['F'];
                         // var na_count = val['NA'];
                         values.push({gender:'M', count: val['M']});
                         values.push({gender:'F', count: val['F']});
                         values.push({gender:'NA', count:val['NA']});

                         res_group.push({custody_status: key, value:values});
                     });

                     max_map = res_group.map(function(o){
                                     a = o.value;

                                     max = Math.max.apply(Math, a.map(function(o) { val = o.count
                                                 if (val == undefined){
                                                   val = 0;
                                                 };
                                               return val;}))
                                     return max;
                             });

                         //    update_bar(res_group);


                       //console.log(res_group);


                       x0_group.domain(['C','U','NA']);
                       x1_group.domain(gender).rangeRoundBands([0, x0_group.rangeBand()]);


                       y_group.domain([0,d3.max(max_map)]);

                       var axisLabelsGroup = ['']

                       svg_group.append("g")
                           .attr("class", "x axis")
                           .attr("transform", "translate(0," + height_group + ")")
                           .call(xAxis_group)
                           .append("text")
                               .attr("x", 250)
                                 .attr("dy", "2.5em")
                               .style("text-anchor", "end")
                               .style('font-weight','bold')
                               .text("custody_status");

                       svg_group.append("g")
                           .attr("class", "yaxis")
                           .call(yAxis_group)
                           .append("text")
                           .attr("transform", "rotate(-90)")
                           .attr("transform","translate(35,20)")
                           .attr("y", -34)
                           .attr("x", -30)
                           .attr("dy", ".81em")
                           .style("text-anchor", "end")
                           .style('font-weight','bold')
                           .text("Count");

                       slice = svg_group.selectAll(".slice")
                           .data(res_group)
                           .enter().append("g")
                           .attr("class", "g")
                           .attr("transform",function(d) { return "translate(" + x0_group(d.custody_status) + ",0)"; });

                           // slice.selectAll("rect")
                           //     .data(function(d) { return d.value; })
                           // .enter().append("rect")
                           //     .attr("width", x1_group.rangeBand())
                           //     .attr("x", function(d) { return x1_group(d.gender); })
                           //     .attr("y", function(d) { return y_group(d.count); })
                           //     .attr("height", function(d) { return height_group - y_group(d.count); })
                           //     .style("fill", function(d) { return color_group(d.gender) })
                           //     .on("mouseover", function(d) {
                           //         d3.select(this)
                           //         .style("fill", d3.rgb(color(d.gender)).darker(2));
                           //
                           //           var gender_labels = {'M':'Male','F':'Female','NA':'NA'}
                           //
                           //         tooltip_group.html(d)
                           //         .style("left", (d3.event.pageX)+"px")
                           //         .style("top",(d3.event.pageY) +"px")
                           //         .style("opacity",1)
                           //         .text(gender_labels[d.gender] +":" +d.count)
                           //
                           //
                           //     })
                           //     .on("mouseout", function(d) {
                           //         d3.select(this).style("fill", color_group(d.gender));
                           //
                           //         tooltip_group.style("opacity",0);
                           //     });

                               //Legend
                               var legend_group = svg_group.selectAll(".legend")
                                   .data(res_group[0].value.map(function(d) {
                                       var gender_labels = {'M':'Male','F':'Female','NA':'NA'};
                                       return gender_labels[d.gender]; }))
                               .enter().append("g")
                                   .attr("class", "legend")
                                   .attr("transform", function(d,i) { return "translate(0," + i * 20 + ")"; });

                               legend_group.append("rect")
                                   .attr("x", width_group - 18)
                                   .attr("width", 18)
                                   .attr("height", 18)
                                   .style("fill", function(d) { return color_group(d); });

                               legend_group.append("text")
                                   .attr("x", width_group - 24)
                                   .attr("y", 9)
                                   .attr("dy", ".35em")
                                   .style("text-anchor", "end")
                                   .text(function(d) {return d; });

                                 svg_group.append("text")
                                         .attr("class","title")
                                         .attr("x", 20)
                                         .attr("y", -15)
                                         .style("font-size","14px")
                                         .text("Deaths based on Custody Status and Gender");

                                      //   update_bar();

                                 slice.selectAll("rect")
                                                   .data(function(d) { return d.value; })
                                               .enter().append("rect")
                                                   .attr("width", x1_group.rangeBand())
                                                   .attr("class","group")
                                                   .attr("x", function(d) { return x1_group(d.gender); })
                                                   .attr("y", function(d) { return y_group(d.count); })
                                                   .attr("height", function(d) { return height_group - y_group(d.count); })
                                                   .style("fill", function(d) { return color_group(d.gender) })
                                                   .style("stroke-width","0.5px")
                                                   .style("stroke","black")
                                                   .on("mouseover", function(d) {
                                                       d3.select(this)
                                                       .style("fill", d3.rgb(color(d.gender)).darker(2));

                                                         var gender_labels = {'M':'Male','F':'Female','NA':'NA'}

                                                       tooltip_group.html(d)
                                                       .style("left", (d3.event.pageX)+"px")
                                                       .style("top",(d3.event.pageY) +"px")
                                                       .style("opacity",1)
                                                       .text(gender_labels[d.gender] +":" +d.count)


                                                   })
                                                   .on("mouseout", function(d) {
                                                       d3.select(this).style("fill", color_group(d.gender));

                                                       tooltip_group.style("opacity",0);
                                                   });





               });

               function update_bar(){

                 slice.selectAll("rect.group").remove();

                svg_group.selectAll(".yaxis").style("opacity","0").remove();
                 y_group.domain([0,d3.max(max_map)]);

                 // d3.select("g.y axis")
                 //    .call(yAxis_group);

                //
                // yAxis_group = d3.svg.axis()
                //       .scale(y_group)
                //       .orient("left");

              //   y_group.range([0, height_group]);

              //      svg_group.call(yAxis_group);

              svg_group.append("g")
                  .attr("class", "yaxis")
                  .call(yAxis_group)
                  .append("text")
                  .attr("transform", "rotate(-90)")
                  .attr("transform","translate(35,0)")
                  .attr("y", -20)
                  .attr("x", -30)
                  .attr("dy", ".81em")
                  .style("text-anchor", "end")
                  .style('font-weight','bold')
                  .text("Count");


                 slice.data(res_group)

                        .selectAll("rect")
                                   .data(function(d) { return d.value; })
                               .enter().append("rect")
                                   .attr("width", x1_group.rangeBand())
                                   .attr("class","group")
                                   .attr("x", function(d) { return x1_group(d.gender); })
                                   .attr("y", function(d) { return y_group(d.count); })
                                   .attr("height", function(d) { return height_group - y_group(d.count); })
                                   .style("fill", function(d) { return color_group(d.gender) })
                                   .style("stroke-width","0.5px")
                                   .style("stroke","black")
                                   .on("mouseover", function(d) {
                                       d3.select(this)
                                       .style("fill", d3.rgb(color(d.gender)).darker(2));

                                         var gender_labels = {'M':'Male','F':'Female','NA':'NA'}

                                       tooltip_group.html(d)
                                       .style("left", (d3.event.pageX)+"px")
                                       .style("top",(d3.event.pageY) +"px")
                                       .style("opacity",1)
                                       .text(gender_labels[d.gender] +":" +d.count)


                                   })
                                   .on("mouseout", function(d) {
                                       d3.select(this).style("fill", color_group(d.gender));

                                       tooltip_group.style("opacity",0);
                                   });
               };



// Array with CSS color names
const CSS_COLOR_NAMES = [
    "FireBrick",
    "Blue",
    "DarkMagenta",
    "DarkOliveGreen",
    "DarkOrange",
    "DarkOrchid",
    "DodgerBlue",
    "Fuchsia",
    "Black",
    "BlanchedAlmond",
    "DimGrey",
    "DodgerBlue",
    "FloralWhite",
    "ForestGreen",
    "Fuchsia",
    "Khaki",
    "Lavender",
    "LavenderBlush",
    "LawnGreen",
    "LemonChiffon"];

var CSS_PIE_AGE = [
  "#ffffcc",
  "#c7e9b4",
  "#7fcdbb",
  "#41b6c4",
  "#2c7fb8",
  "#253494"
];

var CSS_PIE_RACE = [
  "#66c2a5",
  "#fc8d62",
  "#8da0cb",
  "#e78ac3",
  "#a6d854"
];

/** Tooltip */
// Div for tooltip for pie arcs
var div = d3.select(".grid-container1").append("div")
  .attr("class", "tooltip1")
  .style("opacity", 0)
  .style("position", "absolute");

// Global - Helps in bar chart with pie later
var finalModifiedDataAge = [], finalRaceArray = [];

/** Function to build a pie chart */
/*
    tag: The id of the div for svg
    data: The data of the pie chart
    legendTag: The id of the div to append the legend values
    filtr: filter based on bar chart click
*/



function pieBuilder(tag, data, legendTag) {

    // Size of the pie has to be equal on width and length as it's a circle
    var size = 200;
    var pieBox = 180
    var fourth = size / 4;
    var half = size / 2;
    var margin = 97;
    // Offset to set the label on
    var labelOffset = fourth * 1.4;

    // Calculate total to be used to find the percentage later on
    var total = data.reduce(function (prev, after) {
        return prev + after.value;
    }, 0);

    var radius = Math.min(size ,size) / 2 - margin;

    var container = d3.select(tag);

    var chart = container.append('svg').style('width', size).attr('viewBox', '0 0 ' + pieBox + ' ' + pieBox);
    var to_text = "";
    if(tag == "#pie11") {
      to_text = "Deaths by age";
    } else {
      to_text = "Deaths by ethnicity";
    }

    chart.append("text")
        .attr("x", (size / 1.9))
        .attr("y", (35))
        .attr("text-anchor", "middle")
        .style("font-size", "14px")
        .text(to_text);

    var plotArea = chart.append('g').attr('transform', 'translate(' + half + ', ' + half + ')');

    var pie = d3.layout.pie().sort(null).value(function (d) {
        return d.value;
    });

    // Arcs for pie
    var arcs = pie(data);

    var arc = d3.svg.arc().innerRadius(0).outerRadius(fourth);

    // Arc to sit the exterior labels
    var outerArc = d3.svg.arc()
    .innerRadius(labelOffset)
    .outerRadius(labelOffset);

    var plotPath = plotArea.selectAll('path').data(arcs).enter().append('path');

    // Fill colors to pie arcs
    plotPath.style('fill', function (d, i) {
        // Add color with label to legend
        if(tag == '#pie11') {
          document.getElementById(legendTag).insertAdjacentHTML('beforeend', '<div style="font-size:0.9em;"><span class="rounder" style="background-color:' + CSS_PIE_AGE[i] + '"></span> ' + d.data.name + ' (' + (d.data.value / total * 100).toFixed(2) + '%)' + '</div>');
        // Set color of pie-piece
          return CSS_PIE_AGE[i];
        } else {
          document.getElementById(legendTag).insertAdjacentHTML('beforeend', '<div style="font-size:0.9em;"><span class="rounder" style="background-color:' + CSS_PIE_RACE[i] + '"></span> ' + d.data.name + ' (' + (d.data.value / total * 100).toFixed(2) + '%)' + '</div>');
        // Set color of pie-piece
          return CSS_PIE_RACE[i];
        }
    }).attr('stroke', 'white').attr('d', arc).on("mouseover", function(dat) {
        // Set tooltips location on hover
        var pageX = d3.event.pageX;
        var pageY = d3.event.pageY;
        var head = 'Age Range'
        if(tag == '#pie21') {
            head = 'Race'
        }
        div.transition()
            .duration(200)
            .style("opacity", .9);
        return div.html(head + ": " + dat.data.name + "<br/>Percent: "  + (dat.data.value / total * 100).toFixed(2) + "%")
            .style("left", (pageX) + "px")
            .style("top", (pageY - 28) + "px");
        })
      .on("mouseout", function(d) {
          // Remove tooltip on mouse out
          div.transition()
              .duration(500)
              .style("opacity", 0);
      });

// // Add the polylines between chart and labels:
// plotArea
//   .selectAll('allPolylines')
//   .data(arcs)
//   .enter()
//   .append('polyline')
//     .attr("stroke", "black")
//     .style("fill", "none")
//     .attr("stroke-width", 1)
//     .attr('points', function(d) {
//     // Three positions to add the labels on the invisible-outer arc of the pie
//       var posA = arc.centroid(d)
//       var posB = outerArc.centroid(d)
//       var posC = outerArc.centroid(d);
//       var midangle = d.startAngle + (d.endAngle - d.startAngle) / 2;
//       posC[0] = radius * 0.95 * (midangle < Math.PI ? 1 : -1);
//       return [posA, posB, posC];
//     });

// // Add the polylines between chart and labels:
// plotArea
//     .selectAll('allLabels')
//     .data(arcs)
//     .enter()
//     .append('text')
//     .text( function(d) { return d.data.name + ' ' + (d.data.value / total * 100).toFixed(2) + '%'; } )
//     .attr('transform', function(d) {
//         // Add text and transform
//         var pos = outerArc.centroid(d);
//         var midangle = d.startAngle + (d.endAngle - d.startAngle) / 2
//         pos[0] = radius * 0.99 * (midangle < Math.PI ? 1 : -1);
//         return 'translate(' + pos + ')';
//     })
//     .style('text-anchor', function(d) {
//         var midangle = d.startAngle + (d.endAngle - d.startAngle) / 2
//         return (midangle < Math.PI ? 'start' : 'end')
//     }).style('font-size', '10px');

}

function pieBuilterData(filtr) {

  d3.csv("modified_deaths_data.csv",function(data) {
    if(filtr) {
      // data = data.splice(0, filtr.count);

      data = data.filter(function(obj) {
        if(obj.year.split('.')[0] == filtr.year.trim() ) {
          return true;
        }
        return false;
      });
    }

    // Plot by age group
    var initialDataAge = {
        '0-20': 0,
        '21-40': 0,
        '41-60': 0,
        '61-80': 0,
        '>80': 0,
        'unknown': 0
    };

    var initialDataRace = {
      'BLACK': 0,
      'WHITE': 0,
      'HISPANIC': 0,
      'OTHERS': 0,
      'UNKNOWN': 0
    }


data.forEach(function(elem) {
    // Age Categorization
    if(elem.age == "NA") {
        initialDataAge['unknown']++;
    } else if(elem.age > 0 && elem.age <= 20) {
        initialDataAge['0-20']++;
    } else if(elem.age > 20 && elem.age <= 40) {
        initialDataAge['21-40']++;
    } else if(elem.age > 40 && elem.age <= 60) {
        initialDataAge['41-60']++;
    } else if(elem.age > 60 && elem.age <= 80) {
        initialDataAge['61-80']++;
    } else if(elem.age > 80) {
        initialDataAge['>80']++;
    }

    // Race Categorization - If race detail exists + 1 else initiate at 0
    // if(initialDataRace[elem.race_detail] != undefined) {
    //     initialDataRace[elem.race_detail] = initialDataRace[elem.race_detail] + 1;
    // } else {
    //     initialDataRace[elem.race_detail] = 1;
    // }
    //Race Category - Based on race data
      if(elem.race == 'B') {
        initialDataRace['BLACK']++;
      } else if(elem.race == 'W') {
        initialDataRace['WHITE']++;
      } else if(elem.race == 'H') {
        initialDataRace['HISPANIC']++;
      } else if(elem.race == 'O') {
        initialDataRace['OTHERS']++;
      } else if(elem.race == 'A') {
        initialDataRace['OTHERS']++;
      } else if(elem.race == 'PI') {
        initialDataRace['OTHERS']++;
      } else if(elem.race == 'AI') {
        initialDataRace['OTHERS']++;
      } else if(elem.race == 'NA') {
        initialDataRace['UNKNOWN']++;
      }
  });

      // empty container before draw
    d3.select("#pie11").html("");
    d3.select("#pie1label1").html("");
    d3.select("#pie21").html("");
    d3.select("#pie2label1").html("");
    finalModifiedDataAge=[];
  // Data formatting for Age group data
  Object.keys(initialDataAge).forEach(function(key) {
      finalModifiedDataAge.push({name: key, value: initialDataAge[key]});
  });

  // Call the pie builder function to build the age group pie
  pieBuilder("#pie11", finalModifiedDataAge, 'pie1label1');
  finalRaceArray = [];
  // Pie chart by Race detail
  Object.keys(initialDataRace).forEach(function(key) {
          finalRaceArray.push({name: key, value:initialDataRace[key]});
  });

  // Call the pie builder function to build the Race pie
  pieBuilder("#pie21", finalRaceArray, 'pie2label1');
  });

}

pieBuilterData();


</script>

</body>
</html>
